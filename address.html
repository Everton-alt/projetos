<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Endereço</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos específicos para a página de endereço */
        .card {
            margin-bottom: 10px; /* Reduz o espaço entre os cartões */
            padding: 15px;      /* Reduz o padding interno */
        }
        .form-group {
            margin-bottom: 10px; /* Reduz o espaço entre os campos do formulário */
        }
        .form-group label {
            margin-bottom: 5px;  /* Reduz o espaço entre o rótulo e o input */
        }
        .card h2 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        table {
            margin-top: 10px;
        }
        th, td {
            padding: 8px; /* Reduz o padding da tabela */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Cadastro de Endereço</h1>
            <div class="user-info">
                <a href="dashboard.html">Voltar ao Painel</a>
                <span>|</span>
                <a href="#" onclick="auth.logout()">Sair</a>
            </div>
        </div>
        
        <div class="card">
            <h2>Novo Endereço</h2>
            <div id="form-message" class="alert" style="display:none;"></div>
            <div class="form-group">
                <label for="area">Área</label>
                <input type="text" id="area" placeholder="Ex: Corredor A" required>
            </div>
            <div class="form-group">
                <label for="barcodeCode">Código de Endereço (máx. 10 caracteres)</label>
                <input type="text" id="barcodeCode" maxlength="10" placeholder="Ex: 01C01A01A" required>
            </div>
            <div class="barcode-container">
                <svg id="barcodeSvg"></svg>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="addAddress()">Adicionar Endereço</button>
                <button class="btn btn-secondary" onclick="printBarcode()">Imprimir</button>
            </div>
        </div>

        <div class="card">
            <h2>Filtros</h2>
            <div class="filter-grid">
                <div class="form-group">
                    <label for="filterArea">Área:</label>
                    <select id="filterArea"></select>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Importar Endereços em Massa</h2>
            <div id="bulk-message" class="alert" style="display:none;"></div>
            <div class="form-group">
                <label for="bulkFile">Selecionar arquivo XLSX</label>
                <input type="file" id="bulkFile" accept=".xlsx" required>
            </div>
            <button class="btn btn-primary" onclick="handleBulkUpload()">Importar</button>
        </div>

        <div class="card">
            <h2>Endereços Cadastrados</h2>
            <table>
                <thead>
                    <tr>
                        <th>Área</th>
                        <th>Código</th>
                        <th>Código de Barras</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="addressTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="script.js"></script>
    <script>
        let allAddresses = [];

        const populateAreaFilter = () => {
            const filterSelect = document.getElementById('filterArea');
            if (!filterSelect) return;

            const areas = [...new Set(allAddresses.map(address => address.area))];
            areas.sort();
            
            filterSelect.innerHTML = '<option value="">Todas as Áreas</option>';
            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                filterSelect.appendChild(option);
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            allAddresses = addressManager.load();
            populateAreaFilter();
            render.populateAddressTable(allAddresses);
            document.getElementById('barcodeCode').addEventListener('input', generateBarcode);
            
            document.getElementById('filterArea').addEventListener('change', () => {
                const selectedArea = document.getElementById('filterArea').value;
                if (selectedArea === "") {
                    render.populateAddressTable(allAddresses);
                } else {
                    const filteredData = allAddresses.filter(address => address.area === selectedArea);
                    render.populateAddressTable(filteredData);
                }
            });
        });

        const generateBarcode = () => {
            const code = document.getElementById('barcodeCode').value;
            if (code) {
                JsBarcode("#barcodeSvg", code, {
                    format: "CODE128",
                    displayValue: true
                });
            } else {
                document.getElementById('barcodeSvg').innerHTML = '';
            }
        };

        const addAddress = () => {
            const area = document.getElementById('area').value;
            const code = document.getElementById('barcodeCode').value;
            const msgEl = document.getElementById('form-message');

            if (!area || !code) {
                msgEl.className = 'alert alert-error';
                msgEl.textContent = 'Por favor, preencha todos os campos.';
                msgEl.style.display = 'block';
                return;
            }

            addressManager.addEntry({ area, code });
            msgEl.className = 'alert alert-success';
            msgEl.textContent = 'Endereço cadastrado com sucesso!';
            msgEl.style.display = 'block';

            document.getElementById('area').value = '';
            document.getElementById('barcodeCode').value = '';
            document.getElementById('barcodeSvg').innerHTML = '';
            
            allAddresses = addressManager.load();
            populateAreaFilter();
            render.populateAddressTable(allAddresses);
        };

        const deleteAddress = (code) => {
            if (confirm('Tem certeza que deseja excluir este endereço?')) {
                addressManager.deleteEntryByCode(code);
                alert('Endereço excluído com sucesso!');
                allAddresses = addressManager.load();
                populateAreaFilter();
                render.populateAddressTable(allAddresses);
            }
        };

        const printBarcode = (code) => {
            const codeToPrint = code || document.getElementById('barcodeCode').value;
            
            if (!codeToPrint) {
                alert("Por favor, digite ou selecione um código de endereço para imprimir.");
                return;
            }

            const printWindow = window.open('', '_blank');
            let content = '<html><head><title>Imprimir Código de Barras</title>';
            content += '<style>';
            content += 'body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; text-align: center; }';
            content += '.print-item { max-width: 200px; padding: 10px; box-sizing: border-box; }';
            content += '.print-item p { margin: 0; font-size: 14px; }';
            content += 'svg { width: 100%; height: auto; display: block; margin: 0 auto; }';
            content += '@media print { body { -webkit-print-color-adjust: exact; } .print-item { page-break-after: always; } }';
            content += '</style></head><body>';
            
            content += '<div class="print-item">';
            content += `<svg class="barcode" data-code="${codeToPrint}"></svg>`;
            content += `<p>${codeToPrint}</p>`;
            content += `</div>`;

            content += '</body></html>';
            printWindow.document.write(content);

            const jsbarcodeScript = printWindow.document.createElement('script');
            jsbarcodeScript.src = "https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js";
            jsbarcodeScript.onload = () => {
                const svgEl = printWindow.document.querySelector('.barcode');
                const codeAttr = svgEl.getAttribute('data-code');
                JsBarcode(svgEl, codeAttr, {
                    format: "CODE128",
                    displayValue: false
                });
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            };
            printWindow.document.body.appendChild(jsbarcodeScript);
        };
        
        const handleBulkUpload = () => {
            const fileInput = document.getElementById('bulkFile');
            const file = fileInput.files[0];
            const msgEl = document.getElementById('bulk-message');

            if (!file) {
                msgEl.className = 'alert alert-error';
                msgEl.textContent = 'Por favor, selecione um arquivo XLSX.';
                msgEl.style.display = 'block';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const newAddresses = XLSX.utils.sheet_to_json(worksheet, { header: ['Área', 'Código'] });

                if (newAddresses[0] && newAddresses[0].Área === 'Área' && newAddresses[0].Código === 'Código') {
                    newAddresses.shift();
                }

                const result = addressManager.addBulkEntries(newAddresses);
                if (result.success) {
                    msgEl.className = 'alert alert-success';
                    msgEl.textContent = `${result.count} endereços adicionados com sucesso.`;
                } else {
                    msgEl.className = 'alert alert-error';
                    msgEl.textContent = result.message;
                }
                msgEl.style.display = 'block';
                allAddresses = addressManager.load();
                populateAreaFilter();
                render.populateAddressTable(allAddresses);
            };
            reader.readAsArrayBuffer(file);
        };

        render.populateAddressTable = (addresses) => {
            const tableBody = document.getElementById('addressTableBody');
            tableBody.innerHTML = '';
            
            if (addresses.length === 0) {
                const emptyMessage = document.createElement('tr');
                emptyMessage.innerHTML = `<td colspan="4" style="text-align: center;">Nenhum endereço encontrado.</td>`;
                tableBody.appendChild(emptyMessage);
                return;
            }

            addresses.forEach(address => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${address.area}</td>
                    <td>${address.code}</td>
                    <td><svg class="table-barcode" data-code="${address.code}"></svg></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteAddress('${address.code}')">Excluir</button>
                        <button class="btn btn-secondary" onclick="printBarcode('${address.code}')">Imprimir</button>
                    </td>
                `;
            });
            
            document.querySelectorAll('.table-barcode').forEach(svgEl => {
                const code = svgEl.getAttribute('data-code');
                JsBarcode(svgEl, code, {
                    format: "CODE128",
                    displayValue: false
                });
            });
        };
        
        addressManager.deleteEntryByCode = (code) => {
            let addresses = getStorage('addresses');
            const initialLength = addresses.length;
            addresses = addresses.filter(item => item.code !== code);
            setStorage('addresses', addresses);
            return addresses.length < initialLength;
        };
        
    </script>
</body>
</html>